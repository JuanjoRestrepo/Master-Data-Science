//CONSULTA A: sobre Colección carreras
[
  {
    $match: {
      nombre: "Ingeniería de Sistemas"
    }
  },
  {
    $unwind: {
      path: "$cursos"
    }
  },
  {
    $lookup: {
      from: "cursos",
      localField: "cursos.curso",
      foreignField: "_id",
      as: "cursoDetalles"
    }
  },
  {
    $unwind: {
      path: "$cursoDetalles"
    }
  },
  {
    $lookup: {
      from: "profesores",
      localField: "cursoDetalles.profesor",
      foreignField: "_id",
      as: "profesorDetalles"
    }
  },
  {
    $unwind: {
      path: "$profesorDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $match: {
      profesorDetalles: {
        $ne: null
      }
    }
  },
  {
    $project: {
      _id: 1,
      nombreCurso: "$cursoDetalles.nombre",
      nombreProfesor: "$profesorDetalles.nombre",
      calendario: "$cursoDetalles.calendario",
      fechaInicio: "$cursoDetalles.fechaInicio"
    }
  }
]







//CONSULTA B: sobre Colección carreras
[
  // 1. Unwind del array de cursos
  {
    $unwind: {
      path: "$cursos"
    }
  },
  
  // 2. Lookup para obtener los detalles del curso desde la colección "cursos"
  {
    $lookup: {
      from: "cursos",
      localField: "cursos.curso",  // Nos referimos al campo curso dentro del array cursos
      foreignField: "_id",
      as: "cursoDetalles"
    }
  },
  
  // 3. Unwind para acceder a los detalles del curso
  {
    $unwind: {
      path: "$cursoDetalles"
    }
  },

  // 4. Lookup para obtener los detalles del profesor desde la colección "profesores"
  {
    $lookup: {
      from: "profesores",
      localField: "cursoDetalles.profesor",  // Usamos el campo profesor desde cursoDetalles
      foreignField: "_id",
      as: "profesorDetalles"
    }
  },
  
  // 5. Unwind de profesorDetalles para acceder al profesor
  {
    $unwind: {
      path: "$profesorDetalles",
      preserveNullAndEmptyArrays: true  // Mantener los cursos aunque no tengan profesor
    }
  },

  // 6. Lookup para obtener los detalles de la carrera
  {
    $lookup: {
      from: "carreras",
      localField: "carrera",
      foreignField: "_id",
      as: "carreraDetalles"
    }
  },
  
  // 7. Unwind de carreraDetalles para acceder a la carrera
  {
    $unwind: {
      path: "$carreraDetalles",
      preserveNullAndEmptyArrays: true  // Mantener los resultados aunque no tengan carrera
    }
  },

  // 8. Proyectamos los campos que necesitamos
  {
    $project: {
      _id: 1,
      nombreCurso: "$cursoDetalles.nombre",
      nombreProfesor: {
        $concat: [
          { $ifNull: ["$profesorDetalles.nombre", "Sin nombre"] },
        ]
      }
    }
  }
]




// CONSULTA C: FALTA POR TERMINAR
[
  {
    $lookup: {
      from: "estudiantes", // Asumiendo que estás comenzando desde la colección de estudiantes
      localField: "_id",   // ID del estudiante
      foreignField: "_id",
      as: "estudianteDetalles"
    }
  },
  {
    $unwind: {
      path: "$estudianteDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $lookup: {
      from: "cursos",  // Hacemos el lookup con la colección de cursos
      localField: "estudianteDetalles.cursos", // Campo en "estudiantes" que lista los cursos
      foreignField: "_id",
      as: "cursosMatriculados" // Nombre del array que contendrá los cursos ya matriculados
    }
  },
  {
    $unwind: {
      path: "$cursosMatriculados",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $lookup: {
      from: "cursos", // Hacemos el lookup con la colección de cursos
      localField: "cursosMatriculados._id", // Usamos el ID del curso matriculado
      foreignField: "_id",
      as: "cursosDetalles" // Nombre del array para detalles de cursos
    }
  },
  {
    $unwind: {
      path: "$cursosDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $lookup: {
      from: "carreras", // Hacemos el lookup con la colección de carreras
      localField: "cursosDetalles.carrera", // Campo en "cursosDetalles" que relaciona con "carreras"
      foreignField: "_id",
      as: "carreraDetalles"
    }
  },
  {
    $unwind: {
      path: "$carreraDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $match: {
      // Filtra cursos que no están matriculados por el estudiante
      "cursosDetalles._id": { $ne: { $arrayElemAt: ["$cursosMatriculados._id", 0] } } // Comparar con el ID del curso matriculado
    }
  },
  {
    $project: {
      nombreCurso: "$cursosDetalles.nombre", // Nombre del curso
      nombreCarrera: "$carreraDetalles.nombre", // Nombre de la carrera
      semestre: "$cursosDetalles.semestre" // Semestre del curso
    }
  }
]

