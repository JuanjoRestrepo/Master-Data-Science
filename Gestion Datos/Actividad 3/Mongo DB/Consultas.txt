//CONSULTA A: sobre Colección cursos
[
  {
    $match:
      {
        nombre: "Ingeniería de Sistemas"
      }
  },
  
	{
    $unwind: "$cursos"
  },
  {
    $lookup: {
      from: "cursos",
      localField: "cursos.curso",
      foreignField: "_id",
      as: "cursoDetalles"
    }
  },
  {
    $unwind: "$cursoDetalles"
  },


  
	{
    $lookup: {
      from: "profesores",
      localField: "cursoDetalles.profesor",
      foreignField: "_id",
      as: "profesorDetalles"
    }
  },
  {
    $unwind: {
      path: "$profesorDetalles",
      preserveNullAndEmptyArrays: true
    }
  },

  /* Profesores Detalles NULL
  {
    $project: {
      _id: 1, // 0 - cero, para Excluir el _id de la carrera
      nombreCurso: "$cursoDetalles.nombre",
      nombreProfesor: { $concat: ["$profesorDetalles.nombre", " ", "$profesorDetalles.apellido"] },
      calendario: "$cursoDetalles.calendario"
    }
  }*/
  {
    $project: {
      _id: 1, // Excluir el _id de la carrera
      nombreCurso: "$cursoDetalles.nombre",
      nombreProfesor: {
        $concat: [
          { $ifNull: ["$profesorDetalles.nombre", "Sin nombre"] },
          //" ",
          //{ $ifNull: ["$profesorDetalles.apellido", "Sin apellido"] }
        ]
      },
      calendario: "$cursoDetalles.calendario"
    }
  }
  
]




//CONSULTA A MEJORADA
[
  {
    $match: {
      nombre: "Ingeniería de Sistemas"
    }
  },
  {
    $unwind: {
      path: "$cursos"
    }
  },
  {
    $lookup: {
      from: "cursos",
      localField: "cursos.curso",
      foreignField: "_id",
      as: "cursoDetalles"
    }
  },
  {
    $unwind: {
      path: "$cursoDetalles"
    }
  },
  {
    $lookup: {
      from: "profesores",
      localField: "cursoDetalles.profesor",
      foreignField: "_id",
      as: "profesorDetalles"
    }
  },
  {
    $unwind: {
      path: "$profesorDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $match: {
      profesorDetalles: {
        $ne: null
      }
    }
  },
  {
    $project: {
      _id: 1,
      nombreCurso: "$cursoDetalles.nombre",
      nombreProfesor: "$profesorDetalles.nombre",
      calendario: "$cursoDetalles.calendario",
      fechaInicio: "$cursoDetalles.fechaInicio"
    }
  }
]







//CONSULTA B: sobre Colección carreras
[
  {
    $lookup: {
      from: "profesores", // Colección de profesores
      localField: "profesor", // Suponiendo que el campo en cursos se llama "profesor"
      foreignField: "_id",
      as: "profesorDetalles"
    }
  },
  {
    $unwind: {
      path: "$profesorDetalles",
      preserveNullAndEmptyArrays: true // Mantiene los cursos sin profesor
    }
  },

  {
    $lookup: {
      from: "carreras", // Colección de carreras
      localField: "carrera", // Suponiendo que cada curso tiene un campo "carrera" que relaciona con la carrera
      foreignField: "_id",
      as: "carreraDetalles"
    }
  },

  {
    $unwind: {
      path: "$carreraDetalles",
      preserveNullAndEmptyArrays: true // Esto permite que si no hay carrera, siga funcionando
    }
  },

  /* SALE NULL
  {
    $project: {
      nombreCurso: "$nombre",
      nombreProfesor: { $concat: ["$profesorDetalles.nombre", " ", "$profesorDetalles.apellido"] },
      nombreCarrera: "$carreraDetalles.nombre" // Asegúrate de que el campo correcto está aquí
    }
  }*/

  {
    $project: {
      nombreCurso: "$nombre",
      nombreProfesor: {
        $concat: [
          {
            $ifNull: [
              "$profesorDetalles.nombre",
              "Sin nombre"
            ]
          }, // Maneja posibles valores null
          " ",
          {
            $ifNull: [
              "$profesorDetalles.apellido",
              "Sin apellido"
            ]
          }
        ]
      },
      nombreCarrera: {
        $ifNull: [
          "$carreraDetalles.nombre",
          "Sin carrera"
        ]
      } // Maneja posibles valores null
    }
  }
]



// CONSULTA C: FALTA POR TERMINAR
[
  {
    $lookup: {
      from: "estudiantes", // Asumiendo que estás comenzando desde la colección de estudiantes
      localField: "_id",   // ID del estudiante
      foreignField: "_id",
      as: "estudianteDetalles"
    }
  },
  {
    $unwind: {
      path: "$estudianteDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $lookup: {
      from: "cursos",  // Hacemos el lookup con la colección de cursos
      localField: "estudianteDetalles.cursos", // Campo en "estudiantes" que lista los cursos
      foreignField: "_id",
      as: "cursosMatriculados" // Nombre del array que contendrá los cursos ya matriculados
    }
  },
  {
    $unwind: {
      path: "$cursosMatriculados",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $lookup: {
      from: "cursos", // Hacemos el lookup con la colección de cursos
      localField: "cursosMatriculados._id", // Usamos el ID del curso matriculado
      foreignField: "_id",
      as: "cursosDetalles" // Nombre del array para detalles de cursos
    }
  },
  {
    $unwind: {
      path: "$cursosDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $lookup: {
      from: "carreras", // Hacemos el lookup con la colección de carreras
      localField: "cursosDetalles.carrera", // Campo en "cursosDetalles" que relaciona con "carreras"
      foreignField: "_id",
      as: "carreraDetalles"
    }
  },
  {
    $unwind: {
      path: "$carreraDetalles",
      preserveNullAndEmptyArrays: true
    }
  },
  {
    $match: {
      // Filtra cursos que no están matriculados por el estudiante
      "cursosDetalles._id": { $ne: { $arrayElemAt: ["$cursosMatriculados._id", 0] } } // Comparar con el ID del curso matriculado
    }
  },
  {
    $project: {
      nombreCurso: "$cursosDetalles.nombre", // Nombre del curso
      nombreCarrera: "$carreraDetalles.nombre", // Nombre de la carrera
      semestre: "$cursosDetalles.semestre" // Semestre del curso
    }
  }
]

